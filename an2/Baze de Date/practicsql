CREATE DATABASE STS 
GO

CREATE TABLE SECTIE(
    NUMAR INT PRIMARY KEY IDENTITY(1,1)
);

CREATE TABLE CETATENI(
    ID INT PRIMARY KEY IDENTITY(1,1),
    NUME VARCHAR(50),
    PRENUME VARCHAR(50),
    CNP VARCHAR(20),
    NR_SECTIE INT FOREIGN KEY REFERENCES SECTIE(NUMAR)
);

CREATE TABLE CANDIDAT(
    ID INT PRIMARY KEY IDENTITY(1,1),
    NUME VARCHAR(50),
    PRENUME VARCHAR(50),
    DATA_NASTERII DATE
);

CREATE TABLE ECHIPAJE(
    NUMAR INT PRIMARY KEY IDENTITY(1,1),
    NUMAR_MEMBRII INT
)

CREATE TABLE VOT (
    ID_CETATEAN INT FOREIGN KEY REFERENCES CETATENI(ID) UNIQUE,
    ID_SECTIE INT FOREIGN KEY REFERENCES SECTIE(NUMAR),
    ID_CANDIDAT INT FOREIGN KEY REFERENCES CANDIDAT(ID),
    LIST_SUPLIMENTARA BIT DEFAULT 0,

    CONSTRAINT PK_VOT PRIMARY KEY (ID_CETATEAN, ID_SECTIE, ID_CANDIDAT)
) 


CREATE TABLE ECHIPAJE_SECTII(
    ID_ECHIPAJE INT FOREIGN KEY REFERENCES ECHIPAJE(NUMAR),
    ID_SECTIE INT FOREIGN KEY REFERENCES SECTIE(NUMAR),

    CONSTRAINT PK_ECHIPAJE_SECTII PRIMARY KEY (ID_ECHIPAJE, ID_SECTIE)
)





GO
CREATE OR ALTER PROCEDURE CANDIDAT @SECTIE INT,
@ID_CASTIGATOR INT OUTPUT
AS
    DECLARE @NRVOTURI INT;
    DECLARE @NRVOUTIRCANDIDAT INT; 
    
    SELECT @NRVOTURI = COUNT(*) FROM VOT
    WHERE ID_SECTIE = @SECTIE

    SELECT @ID_CASTIGATOR = CANDIDAT.ID, @NRVOUTIRCANDIDAT = COUNT(ID_CANDIDAT) FROM VOT
    JOIN CANDIDAT ON VOT.ID_CANDIDAT = CANDIDAT.ID
    WHERE VOT.ID_SECTIE = @SECTIE
    GROUP BY VOT.ID_CANDIDAT
    ORDER BY COUNT(ID_CANDIDAT) DESC

    RETURN @NRVOUTIRCANDIDAT * 100 / @NRVOTURI ---PROCENT





GO
CREATE OR ALTER VIEW SECTII 
AS 
    SELECT '"[' + VOT.ID_SECTIE + ']: [' + COUNT(VOT.ID_CANDIDAT) + ']"' FROM VOT 
    JOIN CANDIDAT ON VOT.ID_CANDIDAT = CANDIDAT.ID
    WHERE CANDIDAT.NUME LIKE 'Calin Georgescu'
    GROUP BY VOT.ID_SECTIE
    HAVING COUNT(VOT.ID_CANDIDAT) > 500